<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
  
        <script type="text/javascript" src="Drinks/Drinks.js"></script>       
         <div style="width:600px; height:100px;  border-radius:15px; box-shadow:1px 1px 3px #333;">
             <div style="float:left">
                <form name="init" onsubmit="initCU();return false;">
                 PowerSupplyID: <input type="text" name="InitID">
                    <input type="submit" value="Init">
                </form> 
                 
             </div>
             <div style="float:left">

             <led id="connected" value="0" label="Connected" style="float:left"></led>
             </div>
             <p style="float:left"> timestamp: <b id="timestamp">0</b> </p>
             </div>
        <script>
                var initialized="";  
                var timestamp=0;
                 
                function initCU(){
                    var cuname =document.forms["init"]["InitID"].value;
                    if(cuname !=""){
                        var request = new XMLHttpRequest();
                         console.log("answer:"+cuname);
                        request.open("GET","cgi-bin/cu.cgi?InitId="+cuname,true);
                        request.send();
                        initialized=cuname;        
                    } else {
                        alert ("You must specify a valid ID");
                    }
                    return false;
                }
                
                function sendCommand(command,parm){
                    var request= new XMLHttpRequest();
                    console.log("device:"+initialized+" command:"+command+" param:"+parm);
                    request.open("GET","cgi-bin/cu.cgi?dev="+initialized+"&cmd="+command+"&param="+parm,true);
                    request.send();
                }
                function powerSupplyToggle(id){
                    var element=Drinks.getElementById(id);
                    sendCommand("mode","{\"mode_type\":"+element.value+"}");
                }
                function queryInterface(){
                    
                 var request = new XMLHttpRequest();
                 request.open("GET","cgi-bin/cu.cgi?dev="+initialized,true);
                                request.send();

                request.onreadystatechange=function(){
                   if(request.readyState == 4 ){
                       var json_answer=request.responseText;
                       console.log("answer:"+json_answer);
                       if(json_answer=="")
                           return;
                       var json = JSON.parse(json_answer);
                        Object.keys(json).forEach(function(key) {
                        
                         try {
                             var val=json[key];
                           if(typeof(val)=== 'object'){
                               if(val.hasOwnProperty('$numberLong')){
                                   val = val['$numberLong'];
                                   //console.log("key " + key + " has value:" +val);
                               }
                              }
                            if(key == 'cs|csv|timestamp'){
                                if(timestamp!=val){
                                   document.getElementById('timestamp').innerHTML =val;
                                   Drinks.getElementById('connected').toggle(); 
                                } 
                              timestamp = val;

                            } else{
                               console.log("key:" + key +" value:"+json[key]);

                               Drinks.getElementById(key).value=val; 
                            }
                             
                        } catch(err){
                           // console.error(key + " does not exist");
                        }
                         });
                       
                   }
             } 
                }
            
            
            function onload(){
               if(initialized !=""){
                queryInterface();
                }   
            }
     
                   
         </script>
    </head>
    
    <body onload="setInterval(onload,2000);">
        
      <div style="width:600px; height:300px; background-color:gray; border-radius:15px; box-shadow:1px 1px 3px #333;">
    <display id="gau" type="analog" value="0" max_range="200" min_range="0"  height="300" width="500" style="float:left;"></display>
    <div style="float:left">
    <display type="digital" id="current" cipher="5" significative="2"  height="100" width="100" style="float:top;" label="Current"></display>
    <display type="digital" id="set" cipher="5" significative="2"  height="100" width="100" style="float:top;" label="Set"></display>
    </div>
  </div>
      <div style="width:600px; height:200px;  border-radius:15px; box-shadow:1px 1px 3px #333;">

    <switch id="ON" label="ON" onchange="powerSupplyToggle(this.id);"  style="float:left";></switch>
    <knob id="setcurrent" radius="60" type="analog" min_range="0"  max_range="200"  onchange="set.value=this.value" style="float:left;" ></knob> 
    <div>
    <led id="on" value="0" label="ON" style="float:left;margin-left:10px"></led>
    <led id="stby" value="0" label="StBy" style="float:left;margin-left:40px"></led>
    <led id="alarm" value="0" label="Alarm" style="float:left; margin-left:40px"></led>
    </div>
    <slider id="polarity" type="digital" value="0" selectindex="1" style="float:left">
      <option value=”-1”>Neg</option>
      <option value=”0”>Open</option>
      <option value=”1”>Pos</option>
    </slider> 
     </div>

    
    </body>
</html>
