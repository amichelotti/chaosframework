cache:
  paths:
  - /builds/bisegni/chaosframework

stages:
  - build
  - deploy

before_script:
  # Install ssh-agent if not already installed, it is required by Docker.
  # (change apt-get to yum if you use a CentOS-based image)
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'

  # Run ssh-agent (inside the build environment)
  - eval $(ssh-agent -s)

  # Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
  - ssh-add <(echo "$CHAOS_DEPLOY_PRIVATE_KEY")

  # For Docker builds disable host key checking. Be aware that by adding that
  # you are suspectible to man-in-the-middle attacks.
  # WARNING: Use this only with the Docker executor, if you use it with shell
  # you will overwrite your user's SSH config.
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

build_framework_x86_64:
  stage: build
  image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
  script:
    - export NOW=$(date +"%Y%m%d-%H%M%S")
    - export TAR_NAME_POSTFIX="development_"$NOW
    - echo "Working directory:"$PWD
    - echo "Artifact name:"$TAR_NAME_POSTFIX
    - cmake -DCHAOS_ARCHITECTURE_TEST=ON .
    - make  -j  $(nproc) ExperimentalStart
    - make  -j  $(nproc) ExperimentalConfigure
    - make  -j  $(nproc) ExperimentalBuild
    - tar -zcvf /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$TAR_NAME_POSTFIX.tgz /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux
  only:
    - development
    - master

build_framework_arm:
  stage: build
  image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
  script:
    - export NOW=$(date +"%Y%m%d-%H%M%S")
    - export TAR_NAME_POSTFIX="development_"$NOW
    - echo "Working directory:"$PWD
    - echo "Artifact name:"$TAR_NAME_POSTFIX
    - cmake -DCHAOS_TARGET=armhf
    - make  -j  $(nproc) ExperimentalStart
    - make  -j  $(nproc) ExperimentalConfigure
    - make  -j  $(nproc) ExperimentalBuild
    - tar -zcvf /builds/bisegni/chaosframework/chaos-distrib-armhf_$TAR_NAME_POSTFIX.tgz /builds/bisegni/chaosframework/chaos-distrib-armhf
  only:
    - development
    - master

deploy_framework_x86_64:
    stage: deploy
    image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
    script:
      - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
      - export NOW=$(date +"%Y%m%d-%H%M%S")
      - export TAR_NAME_POSTFIX="development_"$NOW
      - echo "scp /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$TAR_NAME_POSTFIX.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/"

deploy_framework_arm:
    stage: deploy
    image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
    script:
      - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
      - export NOW=$(date +"%Y%m%d-%H%M%S")
      - export TAR_NAME_POSTFIX="development_"$NOW
      - echo "scp /builds/bisegni/chaosframework/chaos-distrib-armhf_$TAR_NAME_POSTFIX.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/"
