cache:
  paths:
  - /builds/bisegni/chaosframework

stages:
  - build
  - deploy

before_script:
  - export NOW=$(date +"%Y%m%d-%H%M%S")
  - export TAR_NAME_POSTFIX=$NOW
  - env
  - echo $CHAOS_DEPLOY_PRIVATE_KEY >> /builds/bisegni/chaosframework/deploy.key
  - chmod 600 /builds/bisegni/chaosframework/deploy.key

build_framework_x86_64:
  stage: build
  image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
  script:
    - echo "Working directory:"$PWD
    - echo "Artifact name:"$TAR_NAME_POSTFIX
    - cmake -DCHAOS_ARCHITECTURE_TEST=ON .
    - make  -j  $(nproc) ExperimentalStart
    - make  -j  $(nproc) ExperimentalConfigure
    - make  -j  $(nproc) ExperimentalBuild
    - make install
    - tar -zcf /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$CI_BUILD_REF_SLUG.tgz /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux
    - scp -i /builds/bisegni/chaosframework/deploy.key -o StrictHostKeyChecking=no /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$CI_BUILD_REF_SLUG.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/
  only:
    - development
    - master

build_framework_arm:
  stage: build
  image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
  script:
    - echo "Working directory:"$PWD
    - echo "Artifact name:"$TAR_NAME_POSTFIX
    - cmake -DCHAOS_TARGET=armhf
    - make  -j  $(nproc) ExperimentalStart
    - make  -j  $(nproc) ExperimentalConfigure
    - make  -j  $(nproc) ExperimentalBuild
    - make install
    - tar -zcf /builds/bisegni/chaosframework/chaos-distrib-armhf_$CI_BUILD_REF_SLUG.tgz /builds/bisegni/chaosframework/chaos-distrib-armhf
    - scp -i /builds/bisegni/chaosframework/deploy.key -o StrictHostKeyChecking=no /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$CI_BUILD_REF_SLUG.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/
  only:
    - development
    - master

deploy_framework_x86_64:
    stage: deploy
    image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
    script:
      - echo "scp /builds/bisegni/chaosframework/chaos-distrib-x86_64-Linux_$CI_BUILD_REF_SLUG.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/"
    only:
      - development
      - master

deploy_framework_arm:
    stage: deploy
    image: baltig.infn.it:4567/bisegni/chaos-docker-compilation:latest
    script:
      - echo "scp /builds/bisegni/chaosframework/chaos-distrib-armhf_$CI_BUILD_REF_SLUG.tgz chaosweb@opensource.lnf.infn.it:/var/www/html/binary/chaos/"
    only:
      - development
      - master
